<!DOCTYPE html>
<script>

var x=0;
var y=0;

var realX = 0;
var realY = 0;

var latitude = 0;
var longitude = 0;

var stop = 0;

var targPosApplied = false;

ready = true;
function sendInfo(){  
 if (ready){
   // ready = false;
     var xhttp = new XMLHttpRequest();
     xhttp.onreadystatechange = function() {
       if (this.readyState == 4 && this.status == 200) {
           desLong = 0;
           desLat = 0;
           console.log(this.responseText);
           var i = 0;
            text = this.responseText;
           var val = "";
           while (i<text.length) {
             if (text[i]=='a'){
                realX = parseInt(val);
                val = "";
             } else if (text[i]=='w'){
               realY = parseInt(val);
                val = "";
             } else if (text[i]=='x'){
               latitude = parseInt(val);
                val = "";
             } else if (text[i]=='y'){
               longitude = parseInt(val);
                val = "";
             } else if (text[i]=='h'){
               heading = parseInt(val);
                val = "";
             } else if (text[i]=='l'){
               desLat = parseInt(val);
                val = "";
             } else if (text[i]=='t'){
               desLong = parseInt(val);
                val = "";
             } else {
                val += text[i];
             }

             i+=1;
           }

           document.getElementById("speed").innerHTML = realY;
           document.getElementById("angle").innerHTML = realX;
           document.getElementById("desLong").innerHTML = desLong;
           document.getElementById("desLat").innerHTML = desLat;

           document.getElementById("lat").innerHTML = latitude;
           document.getElementById("long").innerHTML = longitude;

           ready = true;

       } else if (this.status == 0){
         // ready = false;
         // console.log("rs", this.status);
        }
     };

      //displaySpeed();


     shouldOverride = 1;
     if (document.getElementById("observe").checked){
        shouldOverride = 0;
        argList = "?override=0";
     } else {
      argList = "?override=1";
       if (!stop){
      
        argList += "&p=" + x + "&f=" + y;
      }
     }
     if (stop){
        argList += "&s=1"
     }
     if (targPosApplied & document.getElementById("desLatInput").value !== "" & document.getElementById("desLongInput").value !== ""){
        argList += "&l=" + document.getElementById("desLatInput").value;
        argList += "&t=" + document.getElementById("desLongInput").value;
        targPosApplied = false;
      }
      

    console.log(argList);
     xhttp.open('GET', '/_info' + argList, true);
     xhttp.send();
 } else {
    console.log("not ready");
 }
}

var requestInt = setInterval(sendInfo, 500);



function changeSpeed(val){
    if ((val == 87 || val == 38) && y<15) { // forward
     y+=1;
    } else if ((val == 83 || val == 40) && y>-15) {  // backward
     y-=1;

    } else if ((val == 65 || val == 37) && x>-40) { // left
     x-=5;
    } else if ((val == 68 || val == 39) && x<40) { //right
     x+=5;
    }
    console.log(x,y);
    
    if ((val == 32)){ // stop
      x=0;
      y=0;
      sendInfo();
    }
    displaySpeed();
}

document.onkeydown = function(evt) {
    evt = evt || window.event;
    // console.log(evt.keyCode);

    changeSpeed(evt.keyCode)
    // sendInfo();
    //w 87 38
    //a 65 37
    //s 83 40
    //d 68 39
    //space 32
    
};

function displaySpeed(){

     document.getElementById("desSpeed").innerHTML = y;
      document.getElementById("desAngle").innerHTML = x;
    }

function stopNow(){
  if (document.getElementById("stop").innerHTML == "STOP"){
    stop = 1;
    changeSpeed(32);
    document.getElementById("stop").innerHTML = "GO";
  } else {
    stop = 0;
    document.getElementById("stop").innerHTML = "STOP";
  }
}

function setCoords(){


}

function toggleOverride(){
  if (document.getElementById("observe").checked){
    // document.getElementById("targetPositionOverride").style.display = "none";

  } else {
    // document.getElementById("targetPositionOverride").style.display = "inline-block";
  }

}


</script>

<html>
<title>Robot Controller</title>

<!-- <input type="checkbox" id="override" checked = "true" onclick="displaySpeed();"> Override -->

<input type="radio" id="observe" name="action" value="observe" onclick="toggleOverride();" checked>
<label for="observe">observe</label><br>
<input type="radio" id="override" name="action" value="override" onclick="toggleOverride();">
<label for="override">override</label><br>



<br>
Real Speed: <span id="speed">__</span> mph<br>
Desired Speed: <span id="desSpeed">__</span> mph<br>

<br>
Real steering angle: <span id="angle">__</span> degrees<br>
Desired angle: <span id="desAngle">__</span> degrees<br>
<br>


Current Position: <span id="lat">__</span>, <span id="long">__</span><br>


Target Position: 
<span id="desLat">__</span>,  <span id="desLong">__</span>  <br>

<p id= "targetPositionOverride" style="">
Override Target Position <input type="text" id="desLatInput">, <input type="text" id="desLongInput">

<button type="button" id="setTarget", onclick="targPosApplied=true;">apply</button>
</p>


<br>Heading: <span id="heading">__</span> degrees North<br> 

<br>
<button type="button" id="stop", onclick="stopNow();" >STOP</button><br>
<center>
<button type="button" id="forward", onclick="changeSpeed(87);" >forward</button><br>
<button type="button" id="left", onclick="changeSpeed(65);" >left</button>
<button type="button" id="right", onclick="changeSpeed(68);" >right</button><br>
<button type="button" id="back", onclick="changeSpeed(83);" >back</button>
</center>

<script>
displaySpeed();
</script>
<!-- <body onload="setup();"> -->



</html>